

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4.3. Virtual Font File Format &mdash; PyDvi 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="PyDvi 0.1.0 documentation" href="index.html" />
    <link rel="up" title="4. Bibliography" href="bibliography.html" />
    <link rel="next" title="4.4. Relevant Softwares" href="reference-links.html" />
    <link rel="prev" title="4.2. Packet Font File Format" href="pk-format.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference-links.html" title="4.4. Relevant Softwares"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pk-format.html" title="4.2. Packet Font File Format"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyDvi 0.1.0 documentation</a> &raquo;</li>
          <li><a href="bibliography.html" accesskey="U">4. Bibliography</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="virtual-font-file-format">
<h1>4.3. Virtual Font File Format<a class="headerlink" href="#virtual-font-file-format" title="Permalink to this headline">¶</a></h1>
<p>The Virtual Font file format is described in the <tt class="file docutils literal"><span class="pre">vftovp.web</span></tt> file from Web2C.  Part of this
documentation comes from this file.</p>
<p>The idea behind VF files is that a general interface mechanism is needed to switch between the
myriad font layouts provided by different suppliers of typesetting equipment. Without such
mechanism, people must go to great lengths writing inscrutable macros whenever they want to use
typesetting conventions based on one font layout in connection with actual fonts that have another
layout. This puts an extra burden on the typesetting system, interfering with the other things it
needs to do (like kerning, hyphenation, and ligature formation).</p>
<p>These difficulties go away when we have a “virtual font,” i.e., a font that exists in a logical
sense but not a physical sense. A typesetting system like TEX can do its job without knowing where
the actual characters come from; a device driver can then do its job by letting a VF file tell what
actual characters correspond the characters TEX imagined were present. The actual characters can be
shifted and/or magnified and/or combined with other characters from many different fonts. A virtual
font can even make use of characters from virtual fonts, including itself.</p>
<p>Virtual fonts also allow convenient character substitutions for proofreading purposes, when fonts
designed for one output device are unavailable on another.</p>
<p>A VF file is organised as a stream of 8-bit bytes, using conventions borrowed from DVI and PK files.
Thus, a device driver that knows about DVI and PK format will already contain most of the mechanisms
necessary to process VF files. We shall assume that DVI format is understood; the conventions in the
DVI documentation (see, for example, TEX: The Program, part 31) are adopted here to define VF
format.</p>
<p>A preamble appears at the beginning, followed by a sequence of character definitions, followed by a
postamble. More precisely, the first byte of every VF file must be the first byte of the following
“preamble command”: <tt class="docutils literal"><span class="pre">pre</span> <span class="pre">247</span> <span class="pre">i[1]</span> <span class="pre">k[1]</span> <span class="pre">x[k]</span> <span class="pre">cs</span> <span class="pre">[4]</span> <span class="pre">ds</span> <span class="pre">[4]</span></tt>. Here <tt class="docutils literal"><span class="pre">i</span></tt> is the identification byte
of VF, currently 202. The string <tt class="docutils literal"><span class="pre">x</span></tt> is merely a comment, usually indicating the source of the VF
file. Parameters <tt class="docutils literal"><span class="pre">cs</span></tt> and <tt class="docutils literal"><span class="pre">ds</span></tt> are respectively the check sum and the design size of the virtual
font; they should match the first two words in the header of the TFM file, as described below.</p>
<p>After the <tt class="docutils literal"><span class="pre">pre</span></tt> command, the preamble continues with font definitions; every font needed to
specify “actual” characters in later set char commands is defined here. The font definitions are
exactly the same in VF files as they are in DVI files, except that the scaled size <tt class="docutils literal"><span class="pre">s</span></tt> is relative
and the design size <tt class="docutils literal"><span class="pre">d</span></tt> is absolute:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">fnt</span> <span class="pre">def1</span> <span class="pre">243</span> <span class="pre">k[1]</span> <span class="pre">c[4]</span> <span class="pre">s[4]</span> <span class="pre">d[4]</span> <span class="pre">a[1]</span> <span class="pre">l[1]</span> <span class="pre">n[a</span> <span class="pre">+</span> <span class="pre">l]</span></tt>. Define font <tt class="docutils literal"><span class="pre">k</span></tt>, where 0 ≤ k &lt; 256.</li>
<li><tt class="docutils literal"><span class="pre">fnt</span> <span class="pre">def2</span> <span class="pre">244</span> <span class="pre">k[2]</span> <span class="pre">c[4]</span> <span class="pre">s[4]</span> <span class="pre">d[4]</span> <span class="pre">a[1]</span> <span class="pre">l[1]</span> <span class="pre">n[a</span> <span class="pre">+</span> <span class="pre">l]</span></tt>. Define font <tt class="docutils literal"><span class="pre">k</span></tt>, where 0 ≤ k &lt; 65536.</li>
<li><tt class="docutils literal"><span class="pre">fnt</span> <span class="pre">def3</span> <span class="pre">245</span> <span class="pre">k[3]</span> <span class="pre">c[4]</span> <span class="pre">s[4]</span> <span class="pre">d[4]</span> <span class="pre">a[1]</span> <span class="pre">l[1]</span> <span class="pre">n[a</span> <span class="pre">+</span> <span class="pre">l]</span></tt>. Define font <tt class="docutils literal"><span class="pre">k</span></tt>, where 0 ≤ k &lt; 2**24.</li>
<li><tt class="docutils literal"><span class="pre">fnt</span> <span class="pre">def4</span> <span class="pre">246</span> <span class="pre">k[4]</span> <span class="pre">c[4]</span> <span class="pre">s[4]</span> <span class="pre">d[4]</span> <span class="pre">a[1]</span> <span class="pre">l[1]</span> <span class="pre">n[a</span> <span class="pre">+</span> <span class="pre">l]</span></tt>. Define font <tt class="docutils literal"><span class="pre">k</span></tt>, where −2**31 ≤ k &lt; 2**31.</li>
</ul>
<p>These font numbers <tt class="docutils literal"><span class="pre">k</span></tt> are “local”; they have no relation to font numbers defined in the DVI file
that uses this virtual font. The dimension <tt class="docutils literal"><span class="pre">s</span></tt>, which represents the scaled size of the local font
being defined, is a fix word relative to the design size of the virtual font. Thus if the local font
is to be used at the same size as the design size of the virtual font itself, <tt class="docutils literal"><span class="pre">s</span></tt> will be the
integer value 2**20. The value of <tt class="docutils literal"><span class="pre">s</span></tt> must be positive and less than 2**24 (thus less than 16 when
considered as a fix word ). The dimension d is a fix word in units of printer’s points; hence it is
identical to the design size found in the corresponding TFM file.</p>
<p>The preamble is followed by zero or more character packets, where each character packet begins with
byte that is &lt; 243. Character packets have two formats, one long and one short:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">long</span> <span class="pre">char</span> <span class="pre">242</span> <span class="pre">pl</span> <span class="pre">[4]</span> <span class="pre">cc</span> <span class="pre">[4]</span> <span class="pre">tfm</span> <span class="pre">[4]</span> <span class="pre">dvi</span> <span class="pre">[pl</span> <span class="pre">]</span></tt>. This long form specifies a virtual character in the general case.</li>
<li><tt class="docutils literal"><span class="pre">short</span> <span class="pre">char0</span> <span class="pre">...</span> <span class="pre">short</span> <span class="pre">char241</span> <span class="pre">pl</span> <span class="pre">[1]</span> <span class="pre">cc</span> <span class="pre">[1]</span> <span class="pre">tfm</span> <span class="pre">[3]</span> <span class="pre">dvi</span> <span class="pre">[pl</span> <span class="pre">]</span></tt>. This short form specifies a
virtual character in the common case when 0 ≤ pl &lt; 242 and 0 ≤ cc &lt; 256 and 0 ≤ tfm &lt; 2**24.</li>
</ul>
<p>Here <tt class="docutils literal"><span class="pre">pl</span></tt> denotes the packet length following the tfm value; <tt class="docutils literal"><span class="pre">cc</span></tt> is the character code; and
<tt class="docutils literal"><span class="pre">tfm</span></tt> is the character width copied from the TFM file for this virtual font. There should be at
most one character packet having any given <tt class="docutils literal"><span class="pre">cc</span></tt> code.</p>
<p>The <tt class="docutils literal"><span class="pre">dvi</span></tt> bytes are a sequence of complete DVI commands, properly nested with respect to push and
pop.  All DVI operations are permitted except <tt class="docutils literal"><span class="pre">bop</span></tt>, <tt class="docutils literal"><span class="pre">eop</span></tt>, and commands with opcodes
≥ 243. Font selection commands (<tt class="docutils literal"><span class="pre">fnt_num0</span></tt> through <tt class="docutils literal"><span class="pre">fnt4</span></tt>) must refer to fonts defined in the
preamble.</p>
<p>Dimensions that appear in the DVI instructions are analogous to fix word quantities; i.e., they are
integer multiples of 2**−20 times the design size of the virtual font. For example, if the virtual
font has design size 10 pt, the DVI command to move down 5 pt would be a down instruction with
parameter 2**19. The virtual font itself might be used at a different size, say 12 pt; then that
down instruction would move down 6 pt instead. Each dimension must be less than 2**24 in absolute
value.</p>
<p>Device drivers processing VF files treat the sequences of dvi bytes as subroutines or macros,
implicitly enclosing them with push and pop. Each subroutine begins with <tt class="docutils literal"><span class="pre">w</span> <span class="pre">=</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">z</span> <span class="pre">=</span> <span class="pre">0</span></tt>, and
with current font <tt class="docutils literal"><span class="pre">f</span></tt> the number of the first-defined in the preamble (undefined if there’s no
such font). After the dvi commands have been performed, the <tt class="docutils literal"><span class="pre">h</span></tt> and <tt class="docutils literal"><span class="pre">v</span></tt> position registers of
DVI format and the current font <tt class="docutils literal"><span class="pre">f</span></tt> are restored to their former values; then, if the subroutine
has been invoked by a set char or set command, <tt class="docutils literal"><span class="pre">h</span></tt> is increased by the TFM width (properly
scaled)—just as if a simple character had been typeset.</p>
<ul class="simple">
<li>long char = 242 { VF command for general character packet }</li>
<li>set char 0 = 0 { DVI command to typeset character 0 and move right }</li>
<li>set1 = 128 { typeset a character and move right }</li>
<li>set rule = 132 { typeset a rule and move right }</li>
<li>put1 = 133 { typeset a character }</li>
<li>put rule = 137 { typeset a rule }</li>
<li>nop = 138 { no operation }</li>
<li>push = 141 { save the current positions }</li>
<li>pop = 142 { restore previous positions }</li>
<li>right1 = 143 { move right }</li>
<li>w0 = 147 { move right by w }</li>
<li>w1 = 148 { move right and set w }</li>
<li>x0 = 152 { move right by x }</li>
<li>x1 = 153 { move right and set x }</li>
<li>down1 = 157 { move down }</li>
<li>y0 = 161 { move down by y }</li>
<li>y1 = 162 { move down and set y }</li>
<li>z0 = 166 { move down by z }</li>
<li>z1 = 167 { move down and set z }</li>
<li>fnt num 0 = 171 { set current font to 0 }</li>
<li>fnt1 = 235 { set current font }</li>
<li>xxx1 = 239 { extension to DVI primitives }</li>
<li>xxx4 = 242 { potentially long extension to DVI primitives }</li>
<li>fnt def1 = 243 { define the meaning of a font number }</li>
<li>pre = 247 { preamble }</li>
<li>post = 248 { postamble beginning }</li>
<li>improper DVI for VF ≡ 139, 140, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255</li>
</ul>
<p>The character packets are followed by a trivial postamble, consisting of one or more bytes all equal
to post (248). The total number of bytes in the file should be a multiple of 4.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="pk-format.html"
                        title="previous chapter">4.2. Packet Font File Format</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="reference-links.html"
                        title="next chapter">4.4. Relevant Softwares</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/vf-format.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference-links.html" title="4.4. Relevant Softwares"
             >next</a> |</li>
        <li class="right" >
          <a href="pk-format.html" title="4.2. Packet Font File Format"
             >previous</a> |</li>
        <li><a href="index.html">PyDvi 0.1.0 documentation</a> &raquo;</li>
          <li><a href="bibliography.html" >4. Bibliography</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Fabrice Salvaire.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>