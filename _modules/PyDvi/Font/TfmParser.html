<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyDvi.Font.TfmParser &mdash; PyDvi 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <link rel="top" title="PyDvi 0.1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyDvi 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for PyDvi.Font.TfmParser</h1><div class="highlight"><pre>
<span class="c">####################################################################################################</span>
<span class="c"># </span>
<span class="c"># PyDvi - A Python Library to Process DVI Stream</span>
<span class="c"># Copyright (C) 2014 Fabrice Salvaire</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c"># </span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c"># </span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c"># </span>
<span class="c">####################################################################################################</span>

<span class="c">####################################################################################################</span>
<span class="c">#</span>
<span class="c"># Audit</span>
<span class="c">#</span>
<span class="c"># - 11/12/2011 Fabrice</span>
<span class="c">#  - check self registration</span>
<span class="c">#  - read kern table fix word before kern/lig table ?</span>
<span class="c">#</span>
<span class="c">####################################################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The :mod:`TfmParser` module provides a tool to parse TeX Font Metric file.  TFM files contain the</span>
<span class="sd">metrics for TeX fonts.  They have the &quot;.tfm&quot; extension.</span>

<span class="sd">To parse a TFM file and get a :class:`PyDvi.Tfm` instance, use the static method</span>
<span class="sd">:meth:`TfmParser.parse`.  For example use this code for the font &quot;cmr10&quot;::</span>

<span class="sd">  tfm = TfmParser.parse(&#39;cmr10&#39;, &#39;/usr/share/texmf/fonts/tfm/public/cm/cmr10.tfm&#39;)</span>

<span class="sd">The TFM file format in descriped in the :file:`tftopl.web` file from Web2C.  Part of this</span>
<span class="sd">documentation comes from this file.</span>

<span class="sd">The information in a TFM file appears in a sequence of 8-bit bytes. Since the number of bytes is</span>
<span class="sd">always a multiple of 4, we could also regard the file as a sequence of 32-bit words. Note that the</span>
<span class="sd">bytes are considered to be unsigned numbers.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c">####################################################################################################</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;TfmParser&#39;</span><span class="p">]</span>

<span class="c">####################################################################################################</span>

<span class="kn">from</span> <span class="nn">..Tools.EnumFactory</span> <span class="kn">import</span> <span class="n">EnumFactory</span>
<span class="kn">from</span> <span class="nn">..Tools.FuncTools</span> <span class="kn">import</span> <span class="n">repeat_call</span>
<span class="kn">from</span> <span class="nn">..Tools.Stream</span> <span class="kn">import</span> <span class="n">FileStream</span>
<span class="kn">from</span> <span class="nn">.Tfm</span> <span class="kn">import</span> <span class="n">Tfm</span><span class="p">,</span> <span class="n">TfmChar</span><span class="p">,</span> <span class="n">TfmKern</span><span class="p">,</span> <span class="n">TfmLigature</span><span class="p">,</span> <span class="n">TfmExtensibleChar</span>

<span class="c">####################################################################################################</span>

<span class="n">NO_TAG</span><span class="p">,</span> <span class="n">LIG_TAG</span><span class="p">,</span> <span class="n">LIST_TAG</span><span class="p">,</span> <span class="n">EXT_TAG</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">KERN_OPCODE</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c">####################################################################################################</span>

<span class="c">#: Defines the tables present in a TFM file.</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">EnumFactory</span><span class="p">(</span><span class="s">&#39;TableEnums&#39;</span><span class="p">,</span> 
                     <span class="p">(</span><span class="s">&#39;header&#39;</span><span class="p">,</span>
                      <span class="s">&#39;character_info&#39;</span><span class="p">,</span>
                      <span class="s">&#39;width&#39;</span><span class="p">,</span>
                      <span class="s">&#39;height&#39;</span><span class="p">,</span>
                      <span class="s">&#39;depth&#39;</span><span class="p">,</span>
                      <span class="s">&#39;italic_correction&#39;</span><span class="p">,</span>
                      <span class="s">&#39;lig_kern&#39;</span><span class="p">,</span>
                      <span class="s">&#39;kern&#39;</span><span class="p">,</span>
                      <span class="s">&#39;extensible_character&#39;</span><span class="p">,</span>
                      <span class="s">&#39;font_parameter&#39;</span><span class="p">,</span>
                      <span class="p">))</span>

<span class="c">####################################################################################################</span>

<div class="viewcode-block" id="TfmParser"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser">[docs]</a><span class="k">class</span> <span class="nc">TfmParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class parse a TFM file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">##############################################</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TfmParser.parse"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">font_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Parse the TFM :file:`filename` for the font *font_name* and return a :class:`PyDvi.Tfm`</span>
<span class="sd">        instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tfm_parser</span> <span class="o">=</span> <span class="n">TfmParser</span><span class="p">(</span><span class="n">font_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tfm_parser</span><span class="p">()</span>

    <span class="c">##############################################</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">font_name</span> <span class="o">=</span> <span class="n">font_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_lengths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_font_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_lig_kern_programs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_characters</span><span class="p">()</span>

    <span class="c">##############################################</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span>

    <span class="c">##############################################</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TfmParser.word_ptr"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser.word_ptr">[docs]</a>    <span class="k">def</span> <span class="nf">word_ptr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Compute the pointer to the word element index *index* from the base *base*.  A word</span>
<span class="sd">        element has a size of 32-bit.</span>

<span class="sd">          ``prt = base + 4*index``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">index</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._seek_to_table"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._seek_to_table">[docs]</a>    <span class="k">def</span> <span class="nf">_seek_to_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Seek to the table *table*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span><span class="p">[</span><span class="n">table</span><span class="p">])</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._position_in_table"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._position_in_table">[docs]</a>    <span class="k">def</span> <span class="nf">_position_in_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return a pointer to the word element at *index* in the table *table*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_ptr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">index</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_fix_word_in_table"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_fix_word_in_table">[docs]</a>    <span class="k">def</span> <span class="nf">_read_fix_word_in_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return the fix word in table *table* at index *index*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read_fix_word</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position_in_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_four_byte_numbers_in_table"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_four_byte_numbers_in_table">[docs]</a>    <span class="k">def</span> <span class="nf">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return the four numbers in table *table* at index *index*. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read_four_byte_numbers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position_in_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_extensible_recipe"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_extensible_recipe">[docs]</a>    <span class="k">def</span> <span class="nf">_read_extensible_recipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return the extensible recipe, four numbers, at index *index*.</span>

<span class="sd">        Extensible characters are specified by an extensible recipe, which consists of four bytes</span>
<span class="sd">        called top, mid, bot, and rep (in this order). These bytes are the character codes of</span>
<span class="sd">        individual pieces used to build up a large symbol. If top, mid, or bot are zero, they are</span>
<span class="sd">        not present in the built-up result. For example, an extensible vertical line is like an</span>
<span class="sd">        extensible bracket, except that the top and bottom pieces are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">extensible_character</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_lengths"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_lengths">[docs]</a>    <span class="k">def</span> <span class="nf">_read_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot; The fist 24 bytes (6 words) of a TFM file contain twelve 16-bit integers that give the</span>
<span class="sd">        lengths of the various subsequent portions of the file. These twelve integers are, in order:</span>

<span class="sd">        * lf = length of the entire file, in words;</span>
<span class="sd">        * lh = length of the header data, in words;</span>
<span class="sd">        * bc = smallest character code in the font;</span>
<span class="sd">        * ec = largest character code in the font;</span>
<span class="sd">        * nw = number of words in the width table;</span>
<span class="sd">        * nh = number of words in the height table;</span>
<span class="sd">        * nd = number of words in the depth table;</span>
<span class="sd">        * ni = number of words in the italic correction table;</span>
<span class="sd">        * nl = number of words in the lig/kern table;</span>
<span class="sd">        * nk = number of words in the kern table;</span>
<span class="sd">        * ne = number of words in the extensible character table;</span>
<span class="sd">        * np = number of font parameter words.</span>

<span class="sd">        They are all nonnegative and less than 2**15. We must have ``bc - 1 &lt;= ec &lt;= 255``, ``ne &lt;=</span>
<span class="sd">        256``, and</span>
<span class="sd">     </span>
<span class="sd">          ``lf = 6 + lh + (ec - bc + 1) + nw + nh + nd + ni + nl + nk + ne + np``.</span>

<span class="sd">        Note that a font may contain as many as 256 characters (if ``bc = 0`` and ``ec = 255``), and</span>
<span class="sd">        as few as 0 characters (if ``bc = ec + 1``).</span>

<span class="sd">        The rest of the TFM file may be regarded as a sequence of ten data arrays having the</span>
<span class="sd">        informal specification:</span>

<span class="sd">          ========== ===================== ====================</span>
<span class="sd">          header     array [0  ... lh - 1] of stuff</span>
<span class="sd">          char info  array [bc ... ec    ] of char info word</span>
<span class="sd">          width      array [0  ... nw - 1] of fix word</span>
<span class="sd">          height     array [0  ... nh - 1] of fix word</span>
<span class="sd">          depth      array [0  ... nd - 1] of fix word</span>
<span class="sd">          italic     array [0  ... ni - 1] of fix word</span>
<span class="sd">          lig kern   array [0  ... nl - 1] of lig kern command</span>
<span class="sd">          kern       array [0  ... nk - 1] of fix word</span>
<span class="sd">          exten      array [0  ... ne - 1] of extensible recipe</span>
<span class="sd">          param      array [1  ... np    ] of fix word</span>
<span class="sd">          ========== ===================== ====================</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c">###########</span>
        <span class="c"># Read and set table lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entire_file_length</span><span class="p">,</span>
         <span class="n">header_length</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">largest_character_code</span><span class="p">)</span> <span class="o">=</span> <span class="n">repeat_call</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">header_data_length_min</span> <span class="o">=</span> <span class="mi">18</span> <span class="c"># words</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">header_data_length_min</span><span class="p">,</span> <span class="n">header_length</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_chars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">largest_character_code</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span> <span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">character_info</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_chars</span>

        <span class="c"># read the last lengths</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte2</span><span class="p">()</span>

        <span class="c">###########</span>
        <span class="c"># Compute table pointers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>

        <span class="c"># The header starts at 24 bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">tables</span><span class="o">.</span><span class="n">font_parameter</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span><span class="p">[</span><span class="n">table</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position_in_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">table</span><span class="p">])</span>

        <span class="c">###########</span>
        <span class="c"># Sanity check</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">font_parameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">font_parameter</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entire_file_length</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Bad TFM file&#39;</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_header"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_header">[docs]</a>    <span class="k">def</span> <span class="nf">_read_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; The first data array is a block of header information, which contains general facts</span>
<span class="sd">        about the font.  The header must contain at least two words, and for TFM files to be used</span>
<span class="sd">        with Xerox printing software it must contain at least 18 words, allocated as described</span>
<span class="sd">        below.</span>

<span class="sd">        ``header[0]`` is a 32-bit check sum that TEX will copy into the DVI output file whenever it</span>
<span class="sd">        uses the font.  Later on when the DVI file is printed, possibly on another computer, the</span>
<span class="sd">        actual font that gets used is supposed to have a check sum that agrees with the one in the</span>
<span class="sd">        TFM file used by TEX.  In this way, users will be warned about potential incompatibilities.</span>
<span class="sd">        (However, if the check sum is zero in either the font file or the TFM file, no check is</span>
<span class="sd">        made.)  The actual relation between this check sum and the rest of the TFM file is not</span>
<span class="sd">        important; the check sum is simply an identification number with the property that</span>
<span class="sd">        incompatible fonts almost always have distinct check sums.</span>

<span class="sd">        ``header[1]`` is a fix word containing the design size of the font, in units of TEX points</span>
<span class="sd">        (7227 TEX points = 254 cm).  This number must be at least 1.0; it is fairly arbitrary, but</span>
<span class="sd">        usually the design size is 10.0 for a &quot;10 point&quot; font, i.e., a font that was designed to</span>
<span class="sd">        look best at a 10-point size, whatever that really means.  When a TEX user asks for a font</span>
<span class="sd">        &quot;at delta pt&quot;, the effect is to override the design size and replace it by delta, and to</span>
<span class="sd">        multiply the x and y coordinates of the points in the font image by a factor of delta</span>
<span class="sd">        divided by the design size.  All other dimensions in the TFM file are fix word numbers in</span>
<span class="sd">        design-size units.  Thus, for example, the value of ``param[6]``, one em or ``\quad``, is</span>
<span class="sd">        often the fix word value ``2**20 = 1.0``, since many fonts have a design size equal to one</span>
<span class="sd">        em.  The other dimensions must be less than 16 design-size units in absolute value; thus,</span>
<span class="sd">        ``header[1]`` and ``param[1]`` are the only fix word entries in the whole TFM file whose</span>
<span class="sd">        first byte might be something besides 0 or 255.</span>
<span class="sd">        </span>
<span class="sd">        ``header[2 ... 11]``, if present, contains 40 bytes that identify the character coding</span>
<span class="sd">        scheme.  The first byte, which must be between 0 and 39, is the number of subsequent ASCII</span>
<span class="sd">        bytes actually relevant in this string, which is intended to specify what</span>
<span class="sd">        character-code-to-symbol convention is present in the font.  Examples are ASCII for standard</span>
<span class="sd">        ASCII, TeX text for fonts like cmr10 and cmti9, TeX math extension for cmex10, XEROX text</span>
<span class="sd">        for Xerox fonts, GRAPHIC for special-purpose non- alphabetic fonts, UNSPECIFIED for the</span>
<span class="sd">        default case when there is no information.  Parentheses should not appear in this name.</span>
<span class="sd">        (Such a string is said to be in BCPL format.)</span>

<span class="sd">        ``header[12 ... 16]``, if present, contains 20 bytes that name the font family (e.g., CMR or</span>
<span class="sd">        HELVETICA), in BCPL format.  This field is also known as the &quot;font identifier.&quot;</span>

<span class="sd">        ``header[17]``, if present, contains a first byte called the ``seven_bit_safe_flag``, then</span>
<span class="sd">        two bytes that are ignored, and a fourth byte called the *face*.  If the value of the fourth</span>
<span class="sd">        byte is less than 18, it has the following interpretation as a &quot;weight, slope, and</span>
<span class="sd">        expansion&quot;: Add 0 or 2 or 4 (for medium or bold or light) to 0 or 1 (for roman or italic) to</span>
<span class="sd">        0 or 6 or 12 (for regular or condensed or extended).  For example, 13 is ``0+1+12``, so it</span>
<span class="sd">        represents medium italic extended.  A three-letter code (e.g., MIE) can be used for such</span>
<span class="sd">        face data.</span>

<span class="sd">        ``header[18 ... whatever]`` might also be present; the individual words are simply called</span>
<span class="sd">        ``header[18]``, ``header[19]``, etc., at the moment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_seek_to_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c"># Read header[0 ... 1]</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte4</span><span class="p">()</span>
        <span class="n">design_font_size</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_fix_word</span><span class="p">()</span>
        
        <span class="c"># Read header[2 ... 11] if there</span>
        <span class="n">character_info_table_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_pointers</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">character_info</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">character_info_table_position</span><span class="p">:</span>
            <span class="n">character_coding_scheme</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_bcpl</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">character_coding_scheme</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Read header[12 ... 16] if there</span>
        <span class="n">character_coding_scheme_length</span> <span class="o">=</span> <span class="mi">40</span> <span class="c"># bytes (11 - 2 + 1) * 4 = 10 * 4 </span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">character_coding_scheme_length</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">character_info_table_position</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_bcpl</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Read header[12 ... 16] if there</span>
        <span class="n">family_length</span> <span class="o">=</span> <span class="mi">20</span> <span class="c"># bytes (16 - 12 +1) * 4 = 5 * 4 </span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">family_length</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">character_info_table_position</span><span class="p">:</span>
            <span class="n">seven_bit_safe_flag</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte1</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte2</span><span class="p">()</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read_unsigned_byte1</span><span class="p">()</span>
            <span class="c"># Fixme: complete</span>

        <span class="c"># don&#39;t read header [18 ... whatever]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">Tfm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_name</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">largest_character_code</span><span class="p">,</span>
                       <span class="n">checksum</span><span class="p">,</span>
                       <span class="n">design_font_size</span><span class="p">,</span>
                       <span class="n">character_coding_scheme</span><span class="p">,</span>
                       <span class="n">family</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_font_parameters"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_font_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">_read_font_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; The final portion of a TFM fie is the param array, which is another sequence of fix word</span>
<span class="sd">        values.</span>

<span class="sd">        * param[1] = ``slant`` is the amount of italic slant, which is used to help position</span>
<span class="sd">          accents.  For example, slant = .25 means that when you go up one unit, you also go .25</span>
<span class="sd">          units to the right.  The slant is a pure number; it&#39;s the only fix word other than the</span>
<span class="sd">          design size itself that is not scaled by the design size.</span>
<span class="sd">        * param[2] = ``space`` is the normal spacing between words in text. Note that character &quot; &quot;</span>
<span class="sd">          in the font need not have anything to do with blank spaces.</span>
<span class="sd">        * param[3] = ``space_stretch`` is the amount of glue stretching between words.</span>
<span class="sd">        * param[4] = ``space_shrink`` is the amount of glue shrinking between words.</span>
<span class="sd">        * param[5] = ``x_height`` is the height of letters for which accents don&#39;t have to be</span>
<span class="sd">          raised or lowered.</span>
<span class="sd">        * param[6] = ``quad`` is the size of one em in the font.</span>
<span class="sd">        * param[7] = ``extra_space`` is the amount added to param[2] at the ends of sentences.</span>

<span class="sd">        When the character coding scheme is ``TeX math symbols``, the font is supposed to have 15</span>
<span class="sd">        additional parameters called ``num1``, ``num2``, ``num3``, ``denom1``, ``denom2``, ``sup1``,</span>
<span class="sd">        ``sup2``, ``sup3``, ``sub1``, ``sub2``, ``supdrop``, ``subdrop``, ``delim1``, ``delim2``,</span>
<span class="sd">        and ``axis_height``, respectively.  When the character coding scheme is ``TeX math</span>
<span class="sd">        extension``, the font is supposed to have six additional parameters called</span>
<span class="sd">        ``defaul_rule_thickness`` and ``big_op_spacing1`` through ``big_op_spacing5``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_seek_to_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">font_parameter</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">character_coding_scheme</span> <span class="o">==</span> <span class="s">&#39;TeX math italic&#39;</span><span class="p">:</span>
            <span class="c"># undocumented in tftopl web</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Read the seven fix word parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">set_font_parameters</span><span class="p">(</span><span class="n">repeat_call</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read_fix_word</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">character_coding_scheme</span> <span class="o">==</span> <span class="s">&#39;TeX math symbols&#39;</span><span class="p">:</span>
            <span class="c"># Read the additional 15 fix word parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">set_math_symbols_parameters</span><span class="p">(</span><span class="n">repeat_call</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read_fix_word</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">character_coding_scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;TeX math extension&#39;</span><span class="p">,</span>
                                                  <span class="s">&#39;euler substitutions only&#39;</span><span class="p">,</span>
                                                  <span class="p">):</span>
            <span class="c"># Read the additional 6 fix word parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="o">.</span><span class="n">set_math_extension_parameters</span><span class="p">(</span><span class="n">repeat_call</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read_fix_word</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_lig_kern_programs"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_lig_kern_programs">[docs]</a>    <span class="k">def</span> <span class="nf">_read_lig_kern_programs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; The lig kern array contains instructions in a simple programming language that explains</span>
<span class="sd">        what to do for special letter pairs. Each word is a lig kern command of four bytes.</span>

<span class="sd">        * first byte: ``skip_byte``, indicates that this is the final program step if the byte is</span>
<span class="sd">          128 or more, otherwise the next step is obtained by skipping this number of intervening</span>
<span class="sd">          steps.</span>
<span class="sd">        * second byte: ``next_char``, &quot;if ``next_char`` follows the current character, then perform</span>
<span class="sd">          the operation and stop, otherwise continue.&quot;</span>
<span class="sd">        * third byte: ``op_byte``, indicates a ligature step if less than 128, a kern step otherwise.</span>
<span class="sd">        * fourth byte: ``remainder``.</span>

<span class="sd">        In a kern step, an additional space equal to ``kern[256 * (op_byte + 128) + remainder]`` is</span>
<span class="sd">        inserted between the current character and next char.  This amount is often negative, so</span>
<span class="sd">        that the characters are brought closer together by kerning; but it might be positive.</span>

<span class="sd">        There are eight kinds of ligature steps, having ``op_byte`` codes ``4a+2b+c`` where ``0 &lt;= a</span>
<span class="sd">        &lt;= b+c`` and ``0 &lt;= b; c &lt;= 1``.  The character whose code is remainder is inserted between</span>
<span class="sd">        the current character and next char; then the current character is deleted if ``b = 0``, and</span>
<span class="sd">        next char is deleted if ``c = 0``; then we pass over a characters to reach the next current</span>
<span class="sd">        character (which may have a ligature/kerning program of its own).</span>
<span class="sd">        </span>
<span class="sd">        Notice that if ``a = 0`` and ``b = 1``, the current character is unchanged; if ``a = b`` and</span>
<span class="sd">        ``c = 1``, the current character is changed but the next character is unchanged.</span>

<span class="sd">        If the very first instruction of the lig kern array has ``skip_byte = 255``, the</span>
<span class="sd">        ``next_char`` byte is the so-called right boundary character of this font; the value of</span>
<span class="sd">        ``next_char`` need not lie between ``bc`` and ``ec``. If the very last instruction of the</span>
<span class="sd">        lig kern array has ``skip_byte = 255``, there is a special ligature/kerning program for a</span>
<span class="sd">        left boundary character, beginning at location ``256 * op_byte + remainder``.  The</span>
<span class="sd">        interpretation is that TEX puts implicit boundary characters before and after each</span>
<span class="sd">        consecutive string of characters from the same font.  These implicit characters do not</span>
<span class="sd">        appear in the output, but they can affect ligatures and kerning.</span>

<span class="sd">        If the very first instruction of a character&#39;s ``lig_kern`` program has ``skip_byte &gt; 128``,</span>
<span class="sd">        the program actually begins in location ``256 * op_byte + remainder``.  This feature allows</span>
<span class="sd">        access to large lig kern arrays, because the first instruction must otherwise appear in a</span>
<span class="sd">        location ``&lt;= 255``.</span>

<span class="sd">        Any instruction with ``skip_byte &gt; 128`` in the lig kern array must have ``256 * op_byte +</span>
<span class="sd">        remainder &lt; nl``.  If such an instruction is encountered during normal program execution, it</span>
<span class="sd">        denotes an unconditional halt; no ligature command is performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># print &#39;Lig/Kern Table&#39;</span>

        <span class="c"># Fixme: complete special cases</span>

        <span class="c"># Read very first instruction of the table</span>
        <span class="p">(</span><span class="n">first_skip_byte</span><span class="p">,</span>
         <span class="n">next_char</span><span class="p">,</span>
         <span class="n">op_byte</span><span class="p">,</span>
         <span class="n">remainder</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_skip_byte</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">right_boundary_char</span> <span class="o">=</span> <span class="n">next_char</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Font has right boundary char&#39;</span><span class="p">)</span>

        <span class="c"># Read very last instruction of the table</span>
        <span class="p">(</span><span class="n">last_skip_byte</span><span class="p">,</span>
         <span class="n">next_char</span><span class="p">,</span>
         <span class="n">op_byte</span><span class="p">,</span>
         <span class="n">remainder</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_skip_byte</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">left_boundary_char_program_index</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="n">op_byte</span> <span class="o">+</span> <span class="n">remainder</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Font has left boundary char program&#39;</span><span class="p">)</span>

        <span class="c"># Read the instructions</span>
        <span class="n">first_instruction</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">]):</span>
        
            <span class="p">(</span><span class="n">skip_byte</span><span class="p">,</span>
             <span class="n">next_char</span><span class="p">,</span>
             <span class="n">op_byte</span><span class="p">,</span>
             <span class="n">remainder</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="c"># Large lig/kern table ?</span>
            <span class="k">if</span> <span class="n">first_instruction</span> <span class="ow">and</span> <span class="n">skip_byte</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
                <span class="n">large_index</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="n">op_byte</span> <span class="o">+</span> <span class="n">remainder</span>
                <span class="p">(</span><span class="n">skip_byte</span><span class="p">,</span>
                 <span class="n">next_char</span><span class="p">,</span>
                 <span class="n">op_byte</span><span class="p">,</span>
                 <span class="n">remainder</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">,</span> <span class="n">large_index</span><span class="p">)</span>

            <span class="c"># Last step ?</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">skip_byte</span> <span class="o">&gt;=</span> <span class="mi">128</span>

            <span class="k">if</span> <span class="n">op_byte</span> <span class="o">&gt;=</span> <span class="n">KERN_OPCODE</span><span class="p">:</span>
                <span class="c"># Kern step</span>
                <span class="n">kern_index</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="p">(</span><span class="n">op_byte</span> <span class="o">-</span> <span class="n">KERN_OPCODE</span><span class="p">)</span> <span class="o">+</span> <span class="n">remainder</span>
                <span class="n">kern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fix_word_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="n">kern_index</span><span class="p">)</span>
                <span class="c"># Fixme: self registration ?</span>
                <span class="n">TfmKern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">next_char</span><span class="p">,</span> <span class="n">kern</span><span class="p">)</span>
                <span class="c"># print &quot;[%u] Kern O %s R %0.6f&quot; % (i, oct(next_char), kern)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Ligature step</span>
                <span class="n">number_of_chars_to_pass_over</span> <span class="o">=</span> <span class="n">op_byte</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span>
                <span class="n">current_char_is_deleted</span> <span class="o">=</span> <span class="p">(</span><span class="n">op_byte</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">next_char_is_deleted</span>    <span class="o">=</span> <span class="p">(</span><span class="n">op_byte</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">ligature_char_code</span> <span class="o">=</span> <span class="n">remainder</span>
                <span class="c"># Fixme: self registration ?</span>
                <span class="n">TfmLigature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="p">,</span>
                            <span class="n">i</span><span class="p">,</span>
                            <span class="n">stop</span><span class="p">,</span>
                            <span class="n">next_char</span><span class="p">,</span>
                            <span class="n">ligature_char_code</span><span class="p">,</span>
                            <span class="n">number_of_chars_to_pass_over</span><span class="p">,</span>
                            <span class="n">current_char_is_deleted</span><span class="p">,</span>
                            <span class="n">next_char_is_deleted</span><span class="p">)</span>
                <span class="c"># print &quot;[%u] Lig C %s O %s N %u %s %s&quot; % (i,</span>
                <span class="c">#                                          oct(next_char),</span>
                <span class="c">#                                          oct(ligature_char_code),</span>
                <span class="c">#                                          number_of_chars_to_pass_over,</span>
                <span class="c">#                                          current_char_is_deleted,</span>
                <span class="c">#                                          next_char_is_deleted)</span>

            <span class="n">first_instruction</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">==</span> <span class="bp">True</span>

            <span class="c"># if stop:</span>
            <span class="c">#     print &#39;Stop&#39;</span>

            <span class="c"># print &#39;Lig/Kern Table End&#39;</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_characters"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_characters">[docs]</a>    <span class="k">def</span> <span class="nf">_read_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Next comes the char info array, which contains one char info word per character.  Each</span>
<span class="sd">        char info word contains six fields packed into four bytes as follows.</span>

<span class="sd">        * first byte: ``width_index`` (8 bits)</span>
<span class="sd">        * second byte: ``height_index`` (4 bits) times 16, plus depth index (4 bits)</span>
<span class="sd">        * third byte: ``italic_index`` (6 bits) times 4, plus tag (2 bits)</span>
<span class="sd">        * fourth byte: ``remainder`` (8 bits)</span>

<span class="sd">        The actual width of a character is ``width[width_index]``, in design-size units; this is a</span>
<span class="sd">        device for compressing information, since many characters have the same width.  Since it is</span>
<span class="sd">        quite common for many characters to have the same height, depth, or italic correction, the</span>
<span class="sd">        TFM format imposes a limit of 16 different heights, 16 different depths, and 64 different</span>
<span class="sd">        italic corrections.</span>

<span class="sd">        Incidentally, the relation ``width[0] = height[0] = depth[0] = italic[0] = 0`` should</span>
<span class="sd">        always hold, so that an index of zero implies a value of zero.  The width index should never</span>
<span class="sd">        be zero unless the character does not exist in the font, since a character is valid if and</span>
<span class="sd">        only if it lies between ``bc`` and ``ec`` and has a nonzero width index.</span>

<span class="sd">        The tag field in a char info word has four values that explain how to interpret the remainder field.</span>

<span class="sd">        * ``tag = 0`` (``no_tag``) means that remainder is unused.</span>
<span class="sd">        * ``tag = 1`` (``lig_tag``) means that this character has a ligature/kerning program</span>
<span class="sd">          starting at ``lig_kern[remainder]``.</span>
<span class="sd">        * ``tag = 2`` (``list_tag``) means that this character is part of a chain of characters of</span>
<span class="sd">          ascending sizes, and not the largest in the chain.  The remainder field gives the</span>
<span class="sd">          character code of the next larger character.</span>
<span class="sd">        * ``tag = 3`` (``ext_tag``) means that this character code represents an extensible</span>
<span class="sd">          character, i.e., a character that is built up of smaller pieces so that it can be made</span>
<span class="sd">          arbitrarily large.  The pieces are specified in ``exten[remainder]``.</span>
<span class="sd">        * ``no_tag = 0`` vanilla character</span>
<span class="sd">        * ``lig_tag = 1`` character has a ligature/kerning program</span>
<span class="sd">        * ``list_tag = 2`` character has a successor in a charlist</span>
<span class="sd">        * ``ext_tag = 3`` character is extensible</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Read the character information table</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">largest_character_code</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._process_char"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._process_char">[docs]</a>    <span class="k">def</span> <span class="nf">_process_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Process the character code *c* in the character information table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
      
        <span class="n">width_index</span><span class="p">,</span> <span class="n">height_index</span><span class="p">,</span> <span class="n">depth_index</span><span class="p">,</span> <span class="n">italic_index</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_char_info</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># Get the parameters in the corresponding tables</span>
        <span class="k">if</span> <span class="n">width_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fix_word_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">width_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># euex10 has this case</span>
            <span class="c"># raise ValueError(&quot;Zero width character for character code %u&quot; % (c))</span>
        
        <span class="k">if</span> <span class="n">height_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fix_word_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">height_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">depth_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fix_word_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">depth_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">italic_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">italic_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fix_word_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">italic_correction</span><span class="p">,</span> <span class="n">italic_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">italic_correction</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Interpret the tag field</span>
        <span class="n">lig_kern_program_index</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">next_larger_char</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">extensible_recipe</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">LIG_TAG</span><span class="p">:</span>
            <span class="n">lig_kern_program_index</span> <span class="o">=</span> <span class="n">remainder</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">LIST_TAG</span><span class="p">:</span>
            <span class="n">next_larger_char</span> <span class="o">=</span> <span class="n">remainder</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">EXT_TAG</span><span class="p">:</span>
            <span class="n">extensible_recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_extensible_recipe</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extensible_recipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Fixme: self registration ?</span>
            <span class="n">TfmExtensibleChar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="p">,</span>
                              <span class="n">c</span><span class="p">,</span>
                              <span class="n">width</span><span class="p">,</span>
                              <span class="n">height</span><span class="p">,</span>
                              <span class="n">depth</span><span class="p">,</span>
                              <span class="n">italic_correction</span><span class="p">,</span>
                              <span class="n">extensible_recipe</span><span class="p">,</span>
                              <span class="n">lig_kern_program_index</span><span class="p">,</span>
                              <span class="n">next_larger_char</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Fixme: self registration ?</span>
            <span class="n">TfmChar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfm</span><span class="p">,</span>
                    <span class="n">c</span><span class="p">,</span>
                    <span class="n">width</span><span class="p">,</span>
                    <span class="n">height</span><span class="p">,</span>
                    <span class="n">depth</span><span class="p">,</span>
                    <span class="n">italic_correction</span><span class="p">,</span>
                    <span class="n">lig_kern_program_index</span><span class="p">,</span>
                    <span class="n">next_larger_char</span><span class="p">)</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._read_char_info"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._read_char_info">[docs]</a>    <span class="k">def</span> <span class="nf">_read_char_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
 
        <span class="sd">&quot;&quot;&quot; Read the character code *c* data in the character information table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">index</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_four_byte_numbers_in_table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">character_info</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="n">width_index</span>  <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">height_index</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
        <span class="n">depth_index</span>  <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span>
        <span class="n">italic_index</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
        <span class="n">tag</span>          <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span>
        <span class="n">remainder</span>    <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">width_index</span><span class="p">,</span> <span class="n">height_index</span><span class="p">,</span> <span class="n">depth_index</span><span class="p">,</span> <span class="n">italic_index</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">remainder</span>

    <span class="c">##############################################</span>
</div>
<div class="viewcode-block" id="TfmParser._print_summary"><a class="viewcode-back" href="../../../api/PyDvi/Font/TfmParser.html#PyDvi.Font.TfmParser.TfmParser._print_summary">[docs]</a>    <span class="k">def</span> <span class="nf">_print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">string_format</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">TFM </span><span class="si">%s</span><span class="s"></span>

<span class="s"> - Length of the entire file, in words: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Length of the header data, in words: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Smallest character code in the font: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Largest character code in the font: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the width table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the height table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the depth table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the italic correction table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the lig/kern table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the kern table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of words in the extensible character table: </span><span class="si">%u</span><span class="s"></span>
<span class="s"> - Number of font parameter words: </span><span class="si">%u</span><span class="s"></span>
<span class="s">&#39;&#39;&#39;</span>
        
        <span class="k">print</span> <span class="n">string_format</span>  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_name</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">entire_file_length</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">header</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">smallest_character_code</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">largest_character_code</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">width</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">height</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">depth</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">italic_correction</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">lig_kern</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">kern</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">extensible_character</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">table_lengths</span><span class="p">[</span><span class="n">tables</span><span class="o">.</span><span class="n">font_parameter</span><span class="p">],</span>
                                <span class="p">)</span>

<span class="c">####################################################################################################</span>
<span class="c">#</span>
<span class="c"># End</span>
<span class="c">#</span>
<span class="c">####################################################################################################</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyDvi 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Fabrice Salvaire.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>